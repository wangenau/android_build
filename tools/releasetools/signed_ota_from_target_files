#!/bin/bash
# signed_ota_from_target_files (LineageOS 11)
# by wangenau
#
# This script will sign your last generated target files zip and the apks inside
# of it. The first argument of this script has to be the directory to your
# target files packages, the second should be the final zip name. It should be
# called from your working directory (use croot). To successfully run this
# script, release keys have to exist inside ~/.android-certs.

cert_dir=~/.android-certs

# get the newest generated target files package
target_zip=$(cd "$1"; ls -t | awk '{printf("%s",$0);exit}')

# sign the apk files
./build/tools/releasetools/sign_target_files_apks -d "$cert_dir" \
  "$1"/"$target_zip" \
  signed-target_files.zip

# remove an existent signed ota package with the same name
if [ -f "$2".zip ]; then
  rm "$2".zip
fi

# check if the signing apk step was successful
if [ -f signed-target_files.zip ]; then
  # generate a signed ota package
  ./build/tools/releasetools/ota_from_target_files -k "$cert_dir"/releasekey \
    signed-target_files.zip \
    "$2".zip

  # remove the generated signed target files package
  rm signed-target_files.zip
fi

# notify the user if the signing process was successful
if [ -f "$2".zip ]; then
  echo "\033[36m"Signing Complete: $(pwd)/"$2".zip"\033[0m"
else
  echo "\033[31m"Signing failed."\033[0m"
fi
